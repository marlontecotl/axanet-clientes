# ========================================================================
# WORKFLOW 5: MODIFICACIÃ“N DEL CÃ“DIGO DE LA APLICACIÃ“N  
# ========================================================================
#
# ğŸ“‹ PROPÃ“SITO: Detectar automÃ¡ticamente cambios en cÃ³digo
# ğŸ¯ REQUISITOS PROYECTO II: Trigger "push" + NotificaciÃ³n con info del commit

name: "ğŸ”„ Code Modification - DetecciÃ³n de Cambios"

on:
  # TRIGGER PRINCIPAL: PUSH A RAMAS PRINCIPALES
  push:
    branches: 
      - main
      - develop
    paths:
      - '**.py'
      - '**.yml'
      - '**.yaml'
      - 'src/**'
      - 'main.py'
      - 'requirements.txt'

  # TRIGGER MANUAL PARA TESTING
  workflow_dispatch:
    inputs:
      reason:
        description: 'RazÃ³n para ejecuciÃ³n manual'
        required: false
        default: 'Testing del workflow'
        type: string

jobs:
  detect-code-changes:
    name: "ğŸ” Detectar Cambios de CÃ³digo"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "ğŸ” Analizar Cambios"
        id: changes
        run: |
          echo "=== ANALIZANDO CAMBIOS EN CÃ“DIGO ==="
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "EjecuciÃ³n manual: ${{ github.event.inputs.reason }}"
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MSG="EjecuciÃ³n manual del workflow"
            AUTHOR_NAME="${{ github.actor }}"
            BRANCH_NAME="${{ github.ref_name }}"
          else
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MSG=$(git log -1 --pretty=format:"%s")
            AUTHOR_NAME=$(git log -1 --pretty=format:"%an")
            BRANCH_NAME="${{ github.ref_name }}"
            
            echo "Detectando archivos modificados..."
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            echo "Archivos modificados:"
            echo "$CHANGED_FILES"
          fi
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      # STEP PRINCIPAL: FORMATO EXACTO REQUERIDO POR PROYECTO II
      - name: "ğŸ“¢ NotificaciÃ³n Principal - Formato Proyecto II"
        run: |
          echo "[MODIFICACIÃ“N DE CÃ“DIGO DETECTADA]"
          echo "Commit: ${{ steps.changes.outputs.commit_sha }}"
          echo "por ${{ steps.changes.outputs.author }}"
          echo "en rama ${{ steps.changes.outputs.branch }}"
          echo "Mensaje: '${{ steps.changes.outputs.commit_msg }}'"
          echo "Notificando a DevLead y ITTeam para posible revisiÃ³n/despliegue."

      - name: "ğŸ ValidaciÃ³n BÃ¡sica de Python"
        run: |
          echo ""
          echo "ğŸ” EJECUTANDO VALIDACIONES BÃSICAS:"
          
          # Buscar archivos Python
          PYTHON_FILES=$(find . -name "*.py" -not -path "./.git/*" | head -5)
          
          if [ -n "$PYTHON_FILES" ]; then
            echo "ğŸ“„ Verificando sintaxis Python..."
            for file in $PYTHON_FILES; do
              echo "   Verificando: $file"
              python3 -m py_compile "$file" 2>/dev/null && echo "   âœ… Sintaxis OK" || echo "   âš ï¸ Posible problema"
            done
          else
            echo "ğŸ“„ No se encontraron archivos Python modificados"
          fi

      - name: "ğŸ‘¥ NotificaciÃ³n Detallada a Equipos"
        run: |
          echo ""
          echo "ğŸ”„ EQUIPOS NOTIFICADOS:"
          echo "   ğŸ“§ DevLead: carlos-devlead-axanet"
          echo "      â†’ Revisar cambios tÃ©cnicos y arquitectura"
          echo "      â†’ Coordinar code review si es necesario"
          echo ""
          echo "   ğŸ“§ ITTeam: miguel-itops-axanet, sofia-sysadmin-axanet"
          echo "      â†’ Evaluar necesidad de re-deployment"
          echo "      â†’ Preparar rollback plan si es cambio crÃ­tico"
          echo ""
          echo "ğŸ“Š INFORMACIÃ“N DEL CAMBIO:"
          echo "   â€¢ Repositorio: ${{ github.repository }}"
          echo "   â€¢ Workflow: ${{ github.run_id }}"
          echo "   â€¢ Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   â€¢ Evento: ${{ github.event_name }}"
