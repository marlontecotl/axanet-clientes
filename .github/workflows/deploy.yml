# ========================================================================
# WORKFLOW: DEPLOY TO EC2 - CI/CD Pipeline
# ========================================================================
#
# ðŸ“‹ PROPÃ“SITO: ConstrucciÃ³n de imagen Docker y despliegue automÃ¡tico a EC2
# ðŸŽ¯ FLUJO: Build & Push â†’ Deploy to EC2 usando SSH

name: "ðŸš€ Deploy to EC2 - CI/CD Pipeline"

on:
  # TRIGGER: Push a rama main
  push:
    branches: 
      - main
    paths:
      - '**.py'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'src/**'

  # TRIGGER MANUAL para testing
  workflow_dispatch:
    inputs:
      reason:
        description: 'RazÃ³n para despliegue manual'
        required: false
        default: 'Despliegue manual'
        type: string

jobs:
  # ================================
  # JOB 1: BUILD AND PUSH
  # ================================
  build_and_push:
    name: "ðŸ”¨ Build & Push Docker Image"
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Login to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: "ðŸ·ï¸ Extract metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/axanet-clientes
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: "ðŸ”¨ Build and push Docker image"
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: "âœ… Build Success Notification"
        run: |
          echo "ðŸŽ‰ Docker image built successfully!"
          echo "ðŸ“¦ Image: ${{ steps.meta.outputs.tags }}"
          echo "ðŸ”— Digest: ${{ steps.build.outputs.digest }}"

  # ================================
  # JOB 2: DEPLOY TO EC2
  # ================================
  deploy_to_ec2:
    name: "ðŸš€ Deploy to EC2"
    needs: build_and_push
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ”‘ Setup SSH"
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: "ðŸ”§ Add EC2 to known hosts"
        run: |
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: "ðŸš€ Deploy to EC2"
        run: |
          echo "ðŸ”„ Iniciando despliegue en EC2..."
          
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            echo "ðŸ”„ Conectado a EC2 - Iniciando despliegue..."
            
            # Login a Docker Hub en EC2
            echo "ðŸ” Login a Docker Hub..."
            echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            # Pull de la imagen mÃ¡s reciente
            echo "ðŸ“¥ Descargando imagen Docker..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/axanet-clientes:latest || true
            
            # Detener contenedor anterior si existe
            echo "ðŸ›‘ Deteniendo contenedor anterior..."
            docker stop axanet-app || true
            docker rm axanet-app || true
            
            # Ejecutar nuevo contenedor
            echo "ðŸš€ Iniciando nuevo contenedor..."
            docker run -d \
              --name axanet-app \
              --restart unless-stopped \
              -p 80:80 \
              ${{ secrets.DOCKERHUB_USERNAME }}/axanet-clientes:latest
            
            # Limpiar imÃ¡genes no utilizadas (opcional)
            echo "ðŸ§¹ Limpiando imÃ¡genes no utilizadas..."
            docker image prune -af || true
            
            # Verificar que el contenedor estÃ© corriendo
            echo "âœ… Verificando estado del contenedor..."
            docker ps | grep axanet-app
            
            echo "ðŸŽ‰ Â¡Despliegue completado exitosamente!"
          EOF

      - name: "ðŸ” Verify Deployment"
        run: |
          echo "ðŸ” Verificando despliegue..."
          
          # Esperar un momento para que el contenedor inicie
          sleep 10
          
          # Verificar que el servicio estÃ© respondiendo (si es una app web)
          # curl -f http://${{ secrets.EC2_PUBLIC_IP }} || echo "âš ï¸ Servicio no responde en puerto 80"
          
          echo "âœ… VerificaciÃ³n de despliegue completada"

      - name: "ðŸ“Š Deployment Summary"
        run: |
          echo "ðŸ“Š RESUMEN DEL DESPLIEGUE"
          echo "========================"
          echo "ðŸ–¥ï¸  Servidor: ${{ secrets.EC2_PUBLIC_IP }}"
          echo "ðŸ‘¤ Usuario: ${{ secrets.EC2_USER }}"
          echo "ðŸ“¦ Imagen: ${{ needs.build_and_push.outputs.image_tag }}"
          echo "ðŸ”— Acceso: http://${{ secrets.EC2_PUBLIC_IP }}"
          echo "â° Fecha: $(date)"
          echo ""
          echo "ðŸŽ‰ Â¡AplicaciÃ³n Axanet desplegada exitosamente!"