# ========================================================================
# WORKFLOW 6: SOLICITUD DE NUEVAS FUNCIONES A LA APLICACI√ìN
# ========================================================================
#
# üìã PROP√ìSITO: Gestionar solicitudes de funcionalidades completamente nuevas
# ÔøΩÔøΩ REQUISITOS PROYECTO II: workflow_dispatch + Issues con etiqueta "new-feature"

name: "üöÄ New Feature Request - Solicitud de Nueva Funci√≥n"

on:
  # TRIGGER 1: EJECUCI√ìN MANUAL (REQUERIDO)
  workflow_dispatch:
    inputs:
      feature_title:
        description: 'T√≠tulo de la nueva funcionalidad'
        required: true
        default: 'Exportaci√≥n de datos a Excel'
        type: string
      feature_description:
        description: 'Descripci√≥n detallada de la funcionalidad'
        required: true
        default: 'Permitir exportar la lista de clientes a formato Excel'
        type: string
      business_priority:
        description: 'Prioridad de negocio'
        required: true
        default: 'medium'
        type: choice
        options:
        - low
        - medium
        - high
        - critical

  # TRIGGER 2: ISSUES CON ETIQUETA (SUMA PUNTOS)
  issues:
    types: [opened, labeled]

jobs:
  process-feature-request:
    name: "üöÄ Procesar Solicitud de Nueva Funci√≥n"
    runs-on: ubuntu-latest
    
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issues' && 
       contains(github.event.issue.labels.*.name, 'new-feature'))
    
    steps:
      - name: "üîç Identificar Fuente"
        id: source
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Fuente: Ejecuci√≥n manual por ${{ github.actor }}"
            echo "source=manual" >> $GITHUB_OUTPUT
          else
            echo "Fuente: Issue #${{ github.event.issue.number }} por ${{ github.event.issue.user.login }}"
            echo "source=issue" >> $GITHUB_OUTPUT
          fi

      - name: "üìä Extraer Datos de la Funci√≥n"
        id: data
        run: |
          if [ "${{ steps.source.outputs.source }}" = "manual" ]; then
            TITLE="${{ github.event.inputs.feature_title }}"
            DESCRIPTION="${{ github.event.inputs.feature_description }}"
            PRIORITY="${{ github.event.inputs.business_priority }}"
          else
            TITLE="${{ github.event.issue.title }}"
            DESCRIPTION="${{ github.event.issue.body }}"
            PRIORITY="medium"
          fi
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT

      - name: "üÜî Generar Feature ID"
        id: tracking
        run: |
          TIMESTAMP=$(date '+%Y%m%d_%H%M')
          HASH=$(echo "${{ steps.data.outputs.title }}" | sha256sum | cut -c1-6)
          FEATURE_ID="FEAT_${TIMESTAMP}_${HASH}"
          
          echo "feature_id=$FEATURE_ID" >> $GITHUB_OUTPUT
          echo "üÜî Feature ID generado: $FEATURE_ID"

      # STEP PRINCIPAL: FORMATO EXACTO REQUERIDO POR PROYECTO II
      - name: "üì¢ Notificaci√≥n Principal - Formato Proyecto II"
        run: |
          echo "[SOLICITUD DE NUEVA FUNCI√ìN]"
          echo "T√≠tulo: '${{ steps.data.outputs.title }}'"
          echo "Descripci√≥n: '${{ steps.data.outputs.description }}'"
          echo "Pasando a comit√© de priorizaci√≥n (DevLead, ITOpsLead, CustServLead)."
          echo "Notificando a todos."

      - name: "üèõÔ∏è Comit√© de Priorizaci√≥n"
        run: |
          echo ""
          echo "üöÄ COMIT√â DE PRIORIZACI√ìN CONVOCADO:"
          echo ""
          echo "üëë MIEMBROS DEL COMIT√â:"
          echo "   üèÜ DevLead: carlos-devlead-axanet"
          echo "      ‚Üí Evaluar√° factibilidad t√©cnica y esfuerzo"
          echo "      ‚Üí Identificar√° dependencias y riesgos"
          echo ""
          echo "   üîß ITOpsLead: miguel-itops-axanet"  
          echo "      ‚Üí Evaluar√° impacto en infraestructura AWS"
          echo "      ‚Üí Considerar√° aspectos de seguridad y deployment"
          echo ""
          echo "   üë• CustServLead: roberto-cs-axanet"
          echo "      ‚Üí Validar√° utilidad para usuarios finales"
          echo "      ‚Üí Definir√° criterios de aceptaci√≥n"

      - name: "üìä An√°lisis de Prioridad"
        run: |
          PRIORITY="${{ steps.data.outputs.priority }}"
          
          echo ""
          echo "üìä AN√ÅLISIS DE PRIORIDAD: $PRIORITY"
          
          case $PRIORITY in
            "critical")
              echo "üö® PRIORIDAD CR√çTICA:"
              echo "   ‚Ä¢ Evaluaci√≥n inmediata requerida"
              echo "   ‚Ä¢ Posible interrupci√≥n de otros desarrollos"
              echo "   ‚Ä¢ SLA: Decisi√≥n en 24-48 horas"
              ;;
            "high")
              echo "üî• PRIORIDAD ALTA:"
              echo "   ‚Ä¢ Incluir en pr√≥ximo sprint planning"
              echo "   ‚Ä¢ Evaluaci√≥n detallada en 1 semana"
              echo "   ‚Ä¢ SLA: Decisi√≥n en 1-2 semanas"
              ;;
            "medium")
              echo "‚öñÔ∏è PRIORIDAD MEDIA:"
              echo "   ‚Ä¢ Evaluaci√≥n en planning semanal"
              echo "   ‚Ä¢ Incluir en backlog priorizado"
              echo "   ‚Ä¢ SLA: Decisi√≥n en 2-4 semanas"
              ;;
            "low")
              echo "üìã PRIORIDAD BAJA:"
              echo "   ‚Ä¢ Incluir en backlog de features"
              echo "   ‚Ä¢ Evaluaci√≥n cuando recursos disponibles"
              echo "   ‚Ä¢ SLA: Decisi√≥n en 1-2 meses"
              ;;
          esac

      - name: "üìã Informaci√≥n del Workflow"
        run: |
          echo ""
          echo "üìã DETALLES DEL PROCESAMIENTO:"
          echo "   ‚Ä¢ Feature ID: ${{ steps.tracking.outputs.feature_id }}"
          echo "   ‚Ä¢ Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   ‚Ä¢ Repositorio: ${{ github.repository }}"
          echo "   ‚Ä¢ Workflow Run: ${{ github.run_id }}"
          echo "   ‚Ä¢ Ejecutado por: ${{ github.actor }}"
          echo ""
          echo "üéØ PR√ìXIMOS PASOS:"
          echo "   1. Comit√© evaluar√° la solicitud"
          echo "   2. Se determinar√° feasibilidad y esfuerzo"
          echo "   3. Se priorizar√° en roadmap del producto"
          echo "   4. Se notificar√° decisi√≥n al solicitante"
